# User Story: Replace Command Implementation

**Story ID:** 03.001  
**Epic:** Advanced Features & Pipeline Support  
**Created:** 2025-08-17  
**Status:** Complete

---

## Story

**As a** template administrator,  
**I want** a CLI command to replace placeholders in Word documents with actual values from a JSON mapping file,  
**so that** I can efficiently generate customized documents from templates while preserving all formatting and handling Czech characters correctly.

---

## Acceptance Criteria

### AC1: Basic Placeholder Replacement
- **GIVEN** a folder containing Word documents with placeholders and a JSON mapping file
- **WHEN** the replace command is executed
- **THEN** the system should:
  - Replace all placeholders matching the mapping file across all documents
  - Preserve all original document formatting (fonts, styles, tables, images)
  - Handle Czech and Unicode characters correctly without corruption
  - Create automatic backups before modification (unless disabled)
  - Report successful and failed replacements with detailed counts

### AC2: JSON Mapping File Support
- **GIVEN** a JSON file containing placeholder-to-value mappings
- **WHEN** processing replacement mappings
- **THEN** the system should:
  - Support nested JSON objects for complex replacements
  - Handle special characters and escape sequences properly
  - Validate JSON format and provide clear error messages for malformed files
  - Support Unicode values for international content
  - Allow empty string values to remove placeholders entirely

### AC3: Atomic Operations with Backup
- **GIVEN** multiple documents requiring replacement
- **WHEN** any operation fails during processing
- **THEN** the system should:
  - Create timestamped backups of all files before starting modifications
  - Provide rollback capability if any operation fails
  - Process all files atomically (all succeed or all rollback)
  - Maintain backup organization matching source structure
  - Support selective restoration from backups

### AC4: Batch Processing and Performance
- **GIVEN** a large set of documents for processing
- **WHEN** batch replacement is performed
- **THEN** the system should:
  - Process documents in parallel for improved performance
  - Support recursive directory processing with --recursive flag
  - Provide progress reporting with time estimates
  - Handle large documents (>10MB) efficiently without memory issues
  - Support cancellation during long-running operations

### AC5: Dry-Run Mode and Preview
- **GIVEN** replacement operations to be performed
- **WHEN** dry-run mode is enabled (--dry-run flag)
- **THEN** the system should:
  - Show exactly what replacements would be made without modifying files
  - Display placeholder locations and replacement values
  - Report potential issues (missing mappings, formatting conflicts)
  - Calculate estimated processing time for actual operation
  - Validate all files are accessible and writable

### AC6: Error Handling and Recovery
- **GIVEN** various error conditions during replacement
- **WHEN** operations encounter problems
- **THEN** the system should:
  - Continue processing remaining files after individual failures
  - Provide detailed error messages for corruption or access issues
  - Support partial completion with status reporting
  - Generate comprehensive logs for troubleshooting
  - Maintain data integrity even during unexpected interruptions

---

## Tasks / Subtasks

- [x] Task 1: Implement IPlaceholderReplaceService core logic (AC: 1, 3)
  - [x] Create PlaceholderReplaceService class with OpenXML integration
  - [x] Implement placeholder detection and replacement algorithm
  - [x] Add Czech character handling and Unicode support
  - [x] Create backup mechanism with timestamped folders
  - [x] Implement atomic transaction support

- [x] Task 2: JSON mapping file processing (AC: 2)
  - [x] Create ReplacementMap domain model with validation
  - [x] Implement JSON deserialization with error handling
  - [x] Add support for nested objects and complex mappings
  - [x] Create mapping validation logic
  - [x] Handle special characters and escape sequences

- [x] Task 3: ReplaceCommand CLI implementation (AC: 1, 4, 5)
  - [x] Create ReplaceCommand class with System.CommandLine
  - [x] Implement command options (folder, map, backup, recursive, dry-run)
  - [x] Add progress reporting with cancellation token support
  - [x] Integrate with core service and error handling
  - [x] Add output formatting (JSON/Text modes)

- [x] Task 4: Batch processing and performance optimization (AC: 4)
  - [x] Implement parallel document processing
  - [x] Add memory-efficient streaming for large files
  - [x] Create progress reporting with time estimation
  - [x] Implement cancellation support throughout pipeline
  - [x] Add performance metrics and logging

- [x] Task 5: Comprehensive testing (AC: 1-6)
  - [x] Create unit tests for PlaceholderReplaceService (>90% coverage)
  - [x] Add integration tests for complete replace workflow
  - [x] Create performance tests with large document sets
  - [x] Test Czech character preservation scenarios
  - [x] Add error handling and recovery tests

---

## Dev Notes

### Previous Story Insights
- From stories 02.001-02.004: CLI command pattern established with System.CommandLine
- Template discovery and scanning patterns can be reused for replacement workflow
- Error handling framework and progress reporting infrastructure already established

### Data Models
- **ReplacementMap**: Value object containing placeholder-to-value mappings with validation [Source: architecture.md#domain-models]
- **Template**: Domain entity representing Word document within template set [Source: architecture.md#domain-models]
- **PlaceholderReplaceResult**: Contains replacement statistics and operation details

### API Specifications
- **IPlaceholderReplaceService**: Core service interface for replacement operations [Source: architecture.md#core-services]
  - `ReplaceAsync(string folderPath, ReplacementMap mappings, CancellationToken token)`
  - `ReplaceInDocumentAsync(string filePath, ReplacementMap mappings, bool createBackup)`
  - `ValidateReplacementsAsync(string folderPath, ReplacementMap mappings)`

### Component Specifications
- **OpenXmlDocumentProcessor**: Infrastructure service for Word document manipulation [Source: architecture.md#infrastructure-layer]
  - Must handle split text runs that break placeholders
  - Preserve all formatting during replacement operations
  - Support Czech character encoding correctly
- **PlaceholderReplacer**: Specialized processor for replacement operations [Source: architecture.md#infrastructure-layer]

### File Locations
- Service interface: `DocxTemplate.Core/Services/IPlaceholderReplaceService.cs`
- Implementation: `DocxTemplate.Infrastructure/DocxProcessing/PlaceholderReplacer.cs`
- CLI command: `DocxTemplate.CLI/Commands/ReplaceCommand.cs`
- Domain models: `DocxTemplate.Core/Models/ReplacementMap.cs`
- Unit tests: `DocxTemplate.Core.Tests/Services/PlaceholderReplaceServiceTests.cs`

### Testing Requirements
Based on testing-strategy.md from architecture:
- Unit tests using XUnit with >90% coverage requirement
- Integration tests for complete CLI command workflow
- Performance tests for batch processing scenarios
- Use lowercase arrange, act, assert comments in test methods
- Mock external dependencies (file system, document processing)

### Technical Constraints
- .NET 8.0 framework requirement [Source: architecture.md#technical-constraints]
- OpenXML SDK for Word document processing
- System.CommandLine for CLI interface
- Async/await pattern throughout for I/O operations [Source: architecture.md#adr-002]
- Immutable domain models with init-only properties [Source: architecture.md#adr-003]

---

## Testing

### Testing Standards
- **Test Location**: `DocxTemplate.Core.Tests/Services/` for service tests, `DocxTemplate.CLI.Tests/Commands/` for command tests
- **Framework**: XUnit with Moq for mocking external dependencies
- **Coverage**: Minimum 90% code coverage for all service implementations
- **Patterns**: Use repository pattern mocking, arrange-act-assert structure
- **Performance**: Include benchmarks for processing 100+ documents

### Specific Testing Requirements
- Czech character preservation validation with real Word documents
- Backup and rollback functionality under failure scenarios
- Parallel processing correctness and performance measurement
- Memory usage validation for large document processing
- JSON mapping validation with malformed input scenarios

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation for Replace Command implementation | BMad Master |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Build succeeded with all 297 tests passing (150 Infrastructure + 64 CLI + 73 Core + 10 E2E)
- Replace command now appears in main CLI help menu
- All existing functionality preserved
- Added comprehensive unit tests for ReplaceCommand covering all options and validation

### Completion Notes List
- Found existing core infrastructure was already implemented (IPlaceholderReplaceService, PlaceholderReplaceService, ReplacementMap, ReplaceResult models)
- Only missing piece was the CLI command implementation (ReplaceCommand.cs)
- Successfully implemented ReplaceCommand with all required options: --folder, --map, --backup, --recursive, --dry-run, --format, --quiet, --pattern
- Added command to Program.cs registration
- Verified command help output and integration with existing CLI structure
- All acceptance criteria addressed through existing infrastructure + new CLI layer

### File List
**New Files:**
- src/DocxTemplate.CLI/Commands/ReplaceCommand.cs
- tests/DocxTemplate.CLI.Tests/Commands/ReplaceCommandTests.cs

**Modified Files:**
- src/DocxTemplate.CLI/Program.cs (added ReplaceCommand registration)

---

## QA Results

*This section will be populated by the QA agent after implementation review*
