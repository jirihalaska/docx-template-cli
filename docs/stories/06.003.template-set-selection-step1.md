# Story 06.003: Template Set Selection (Step 1)

## Status
Done

## Story
**As a** business user starting the template processing workflow,  
**I want** to select a template set from available folders,  
**so that** I can choose which group of templates to process.

## Acceptance Criteria
1. Automatically scan `./templates` folder on wizard launch
2. Display each subfolder as a clickable button/tile with template count
3. Show template count for each subfolder (e.g., "Smlouvy (15 souborů)")
4. Highlight selected template set with visual indication
5. "Další" (Next) button enabled only after template set selection
6. Show "Nenalezeny šablony" message if `./templates` folder is missing or empty
7. Czech language labels and error messages throughout

## Tasks / Subtasks
- [x] Create template set discovery service (AC: 1)
  - [x] Implement ITemplateSetDiscoveryService interface
  - [x] Create TemplateSetDiscoveryService using CLI list-sets command
  - [x] Parse CLI JSON output for template set information
- [x] Implement Step 1 ViewModel (AC: 2, 4, 5)
  - [x] Create TemplateSetSelectionViewModel extending StepViewModelBase
  - [x] Implement TemplateSets observable collection
  - [x] Create SelectedTemplateSet property with validation
  - [x] Implement template set selection command
- [x] Create Step 1 UI (AC: 2, 3, 4, 7)
  - [x] Design TemplateSetSelectionView with button/tile layout
  - [x] Create template set button template with count display
  - [x] Implement selection highlighting with visual feedback
  - [x] Add Czech labels: "Vyberte sadu šablon"
- [x] Implement error handling (AC: 6, 7)
  - [x] Handle missing ./templates folder scenario
  - [x] Display Czech error message: "Ve složce ./templates nebyly nalezeny žádné šablony"
  - [x] Show guidance message for folder setup
- [x] Integrate with wizard navigation (AC: 5)
  - [x] Implement step validation logic for template selection
  - [x] Enable "Další" button only when template set is selected
  - [x] Pass selected template set to wizard state

## Dev Notes

### Architecture Context
Based on GUI PRD Functional Requirements FR2 and Technical Architecture:

**CLI Integration Requirements:**
Uses CLI `list-sets` command with JSON output:
```bash
list-sets --templates ./templates --format json
```

**Expected CLI JSON Response:**
```json
{
  "command": "list-sets",
  "success": true,
  "data": {
    "template_sets": [
      {
        "name": "Contracts", 
        "file_count": 15,
        "total_size_formatted": "2.3 MB"
      }
    ]
  }
}
```

**Czech Language Requirements (FR7):**
- Step title: "Vyberte sadu šablon" 
- Template count format: "Smlouvy (15 souborů)"
- Error message: "Ve složce ./templates nebyly nalezeny žádné šablony. Zkontrolujte prosím, že složka existuje a obsahuje podsložky se šablonami Word."
- Guidance: "Vytvořte složku './templates' a přidejte do ní podsložky s vašimi šablonami .docx"

**UI Design Pattern:**
```
┌─────────────────────────────────────────┐
│  Procesor šablon DOCX - Krok 1 z 5     │  
├─────────────────────────────────────────┤
│  ● ○ ○ ○ ○  [Indikátory kroků]        │
│                                         │
│  Vyberte sadu šablon                    │
│  [Smlouvy (15)]   [Faktury (8)]       │
│  [Zprávy (12)]    [Dopisy (5)]        │ 
│                                         │
│                   [Zpět]    [Další]    │
└─────────────────────────────────────────┘
```

**Service Integration:**
- Uses CliProcessRunner to execute list-sets command
- CliResultParser handles JSON response parsing
- Service follows async/await pattern for responsiveness

**Error Handling Scenarios:**
- Missing ./templates folder
- Empty ./templates folder  
- CLI command execution failure
- Invalid JSON response from CLI

### Testing
**Testing Standards:**
- Unit tests location: `tests/DocxTemplate.UI.Tests/ViewModels/`
- Mock ITemplateSetDiscoveryService for ViewModel testing
- Test CLI integration service with sample JSON responses
- Integration tests with actual ./templates folder scenarios

**Specific Testing Requirements:**
- Test template set discovery with valid folders
- Test error scenarios: missing folder, empty folder, CLI failure
- Verify Czech language text rendering
- Test template set selection and validation
- Test "Další" button enable/disable logic
- Verify CLI JSON parsing with various response formats

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-18 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
- Build issues resolved with dependency injection setup
- NSubstitute mocking patterns implemented for async ReactiveCommand testing
- UI layout simplified for Avalonia compatibility

### Completion Notes List
- Successfully implemented template set discovery via CLI integration
- Created reactive UI with proper validation and Czech localization
- Integrated with wizard navigation framework using dependency injection
- All acceptance criteria met and unit tested
- Error handling covers missing templates folder and CLI failures

### File List
- src/DocxTemplate.UI/Services/ITemplateSetDiscoveryService.cs (created)
- src/DocxTemplate.UI/Services/TemplateSetDiscoveryService.cs (created)
- src/DocxTemplate.UI/ViewModels/StepViewModelBase.cs (created)
- src/DocxTemplate.UI/ViewModels/TemplateSetSelectionViewModel.cs (created)
- src/DocxTemplate.UI/Views/Steps/Step1TemplateSelectionView.axaml (modified)
- src/DocxTemplate.UI/Converters/BooleanToThicknessConverter.cs (created)
- src/DocxTemplate.UI/ServiceRegistration.cs (created)
- src/DocxTemplate.UI/App.axaml.cs (modified)
- src/DocxTemplate.UI/ViewModels/WizardViewModel.cs (modified)
- src/DocxTemplate.UI/DocxTemplate.UI.csproj (modified)
- tests/DocxTemplate.UI.Tests/Services/TemplateSetDiscoveryServiceTests.cs (created)
- tests/DocxTemplate.UI.Tests/ViewModels/TemplateSetSelectionViewModelTests.cs (created)

## QA Results
*Results from QA Agent QA review of the completed story implementation*