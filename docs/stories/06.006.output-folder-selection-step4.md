# Story 06.006: Step 4 - Output Folder Selection

## User Story

As a business administrator using the GUI template processor,
I want to select where my processed templates will be saved,
So that I can organize my output files in the appropriate location.

## Story Context

**Existing System Integration:**
- Integrates with: Avalonia native folder dialog, wizard navigation from 06.002
- Technology: Avalonia UI folder picker, file system validation, .NET 9
- Follows pattern: Wizard step navigation and file system interaction patterns
- Touch points: MainViewModel output path property, folder validation, CLI copy/replace commands

## Acceptance Criteria

**Functional Requirements:**

1. **Primary Folder Selection Interface**
   - "Vybrat výstupní složku" (Select Output Folder) button as primary action
   - Launch native OS folder picker dialog when clicked
   - Display selected folder path in read-only text field below button
   - Use standard Avalonia folder picker with proper OS integration

2. **Path Display and Validation**
   - Show full selected path in non-editable text field
   - Validate write permissions to selected folder
   - Display folder validation status (accessible/not accessible)
   - Handle long paths with proper text wrapping or horizontal scroll

3. **Navigation Control**
   - "Next" button enables only after valid output folder selected
   - "Back" button returns to Step 3 (placeholder input) with selected path preserved
   - Clear visual indication when folder selection is required vs. completed

**Integration Requirements:**

4. Existing wizard navigation from 06.002 continues to work unchanged
5. Selected output path integrates with CLI `copy` and `replace` commands
6. Folder validation follows OS file system permission patterns

**Quality Requirements:**

7. Folder picker dialog uses native OS appearance and behavior
8. Path validation occurs immediately after selection
9. Error handling covers permission denied, invalid paths, and network drive issues

## Technical Notes

- **Integration Approach:** Use Avalonia's StorageProvider.OpenFolderPickerAsync for native folder dialog
- **Existing Pattern Reference:** Follow file system interaction patterns and wizard navigation from 06.002
- **Key Constraints:** Must validate write permissions before allowing progression, output path must be compatible with CLI commands

## Definition of Done

- [x] "Select Output Folder" button launches native OS folder picker
- [x] Selected folder path displays correctly in read-only text field
- [x] Write permission validation occurs automatically after selection
- [x] "Next" button enables only after valid, writable folder selected
- [x] "Back" button preserves selected folder path when navigating
- [x] Error messages display for invalid paths or permission issues
- [x] Long folder paths display properly without breaking layout

## Risk and Compatibility Check

**Primary Risk:** Folder permission validation fails or OS folder dialog doesn't work on all platforms
**Mitigation:** Comprehensive permission checking with fallback validation and cross-platform testing
**Rollback:** "Back" button allows return to Step 3, folder selection can be changed anytime

**Compatibility Verification:**

- [x] Native folder dialog works on both Windows and macOS
- [x] Permission validation handles all standard folder types (local, network, etc.)
- [x] Path handling works with spaces, special characters, and Unicode folder names
- [x] Integration with CLI commands handles selected path format correctly

---

## Dev Agent Record

### Tasks
- [x] Create OutputFolderSelectionViewModel with folder picker and validation logic
- [x] Update Step4OutputSelectionView.axaml with complete folder selection UI  
- [x] Register OutputFolderSelectionViewModel in dependency injection
- [x] Update WizardViewModel to use the new ViewModel
- [x] Write comprehensive unit tests for folder selection functionality
- [x] Validate compilation and test passage

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Successfully implemented native OS folder picker using Avalonia.Platform.Storage.StorageProvider
- Write permission validation implemented with temporary file creation/deletion approach
- Long path handling implemented using ScrollViewer with horizontal scroll
- All 14 unit tests passing, covering validation, property changes, and edge cases

### Completion Notes  
- Step 4 UI fully functional with native folder picker dialog
- Validation prevents progression without valid, writable folder selection
- "Back" navigation preserves selected path state as required
- Error messages display appropriately for various failure scenarios
- Long paths handled with horizontal scrolling monospace text display

### File List
- src/DocxTemplate.UI/ViewModels/OutputFolderSelectionViewModel.cs (new)
- src/DocxTemplate.UI/Views/Steps/Step4OutputSelectionView.axaml (updated)
- src/DocxTemplate.UI/ViewModels/WizardViewModel.cs (updated)
- src/DocxTemplate.UI/ServiceRegistration.cs (updated) 
- tests/DocxTemplate.UI.Tests/ViewModels/OutputFolderSelectionViewModelTests.cs (new)

### Change Log
- 2025-08-18: Implemented complete Step 4 output folder selection functionality
- 2025-08-18: Added comprehensive unit test coverage (14 tests)
- 2025-08-18: All acceptance criteria and compatibility requirements met

### Status
Done