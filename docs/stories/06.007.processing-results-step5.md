# Story 06.007: Step 5 - Processing & Results

## User Story

As a business administrator using the GUI template processor,
I want to execute the template processing and see clear results,
So that I can confirm my documents were created successfully and access them easily.

## Story Context

**Existing System Integration:**
- Integrates with: CLI `copy` and `replace` commands, wizard navigation from 06.002
- Technology: CLI process execution, Avalonia UI progress feedback, .NET 9
- Follows pattern: CLI integration patterns from previous steps, async operations
- Touch points: CLI command orchestration, progress indication, file system operations

## Acceptance Criteria

**Functional Requirements:**

1. **Processing Summary and Initiation**
   - Display summary of selections (template set name, output folder, placeholder count)
   - "Zpracovat šablony" (Process Templates) button to start processing
   - Clear indication of what will happen when processing starts
   - Confirmation step before beginning irreversible operations

2. **CLI Command Orchestration**
   - Execute CLI `copy --source "[template-path]" --target "[output-path]" --format json`
   - Create temporary JSON mapping file from Step 3 placeholder values
   - Execute CLI `replace --folder "[output-path]" --map "[temp-json]" --format json`
   - Handle command sequencing and error recovery between steps

3. **Progress and Status Feedback**
   - Show "Kopírování šablon..." (Copying templates...) during copy phase
   - Show "Nahrazování zástupných symbolů..." (Replacing placeholders...) during replace phase
   - Display real-time status messages from CLI JSON output
   - Progress indication for long-running operations
   - Capture all CLI output (stdout/stderr) to processing log file

4. **Results and Post-Processing Actions**
   - Success message with processing summary (e.g., "Zpracováno 15 šablon")
   - Display processing log file path in results (e.g., "Log: C:\Temp\docx-processing-20250118-143052.log")
   - "Otevřít složku" (Open Output Folder) button after successful completion
   - "Otevřít log" (Open Log) button to view processing log file
   - "Začít znovu" (Start Over) button to return to Step 1
   - Processing summary includes log file location for future reference

**Integration Requirements:**

5. Existing wizard navigation from 06.002 integrates with final step behavior
6. CLI command execution follows established JSON parsing patterns from previous steps
7. File system operations integrate with OS shell for "open folder" functionality

**Quality Requirements:**

8. Processing operations are fully asynchronous and don't block UI
9. Error handling covers CLI failures, file permission issues, and disk space problems
10. Log file is created with timestamp-based filename for uniqueness
11. Log file persists after processing completion for troubleshooting
12. Cleanup of temporary JSON mapping files after processing completes (log file remains)

## Technical Notes

- **Integration Approach:** Orchestrate CLI commands in sequence with proper error handling, logging, and cleanup
- **Existing Pattern Reference:** Follow CLI integration patterns from Steps 2-4 and async operation patterns from 06.002
- **Key Constraints:** Must handle partial failures (copy succeeds, replace fails) with proper user feedback and recovery options
- **Log File Format:** Use timestamp-based naming: `docx-processing-YYYYMMDD-HHMMSS.log` in system temp directory

## Definition of Done

- [x] Processing summary displays all selections clearly before execution
- [x] "Process Templates" button triggers CLI copy and replace commands in sequence
- [x] All CLI output (stdout/stderr) is captured to timestamped log file
- [x] Progress feedback shows current operation and status messages
- [x] Success state displays processing results with log file path
- [x] "Open Folder" launches OS file manager to output directory
- [x] "Open Log" button opens processing log file in default text editor
- [x] Log file path is displayed in results for future reference
- [x] Error handling covers all CLI failure scenarios with user-friendly messages
- [x] Temporary JSON mapping files are created, used, and cleaned up properly
- [x] Log file persists after processing completion for troubleshooting

## Risk and Compatibility Check

**Primary Risk:** Partial processing failure (copy succeeds but replace fails) leaving user with incomplete output
**Mitigation:** Clear error messages indicate which phase failed, detailed processing log captures all CLI output for troubleshooting, option to retry replace operation
**Rollback:** "Start Over" returns to Step 1, failed processing leaves source templates unchanged, log file available for analysis

**Compatibility Verification:**

- [x] CLI command orchestration handles errors gracefully without leaving corrupted state
- [x] Log file creation and access works across different OS file systems
- [x] "Open Log" functionality works with default text editors on Windows and macOS
- [x] Temporary file handling works across different OS file systems  
- [x] "Open Folder" functionality works on both Windows and macOS
- [x] Progress feedback remains responsive during heavy disk I/O operations
- [x] Log file timestamps use consistent format across different OS locales

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### File List
- **Created:** `src/DocxTemplate.UI/ViewModels/ProcessingResultsViewModel.cs` - Complete ViewModel for Step 5 with CLI orchestration, progress tracking, and result display
- **Updated:** `src/DocxTemplate.UI/Views/Steps/Step5ProcessingResultsView.axaml` - Complete UI layout with processing summary, progress indication, and action buttons  
- **Updated:** `src/DocxTemplate.UI/ViewModels/WizardViewModel.cs` - Integration with ProcessingResultsViewModel and data transfer from previous steps
- **Updated:** `src/DocxTemplate.UI/ServiceRegistration.cs` - Registration of ProcessingResultsViewModel in DI container
- **Updated:** `src/DocxTemplate.UI/Services/ITemplateSetDiscoveryService.cs` - Added missing using System directive
- **Created:** `tests/DocxTemplate.UI.Tests/ViewModels/ProcessingResultsViewModelTests.cs` - Comprehensive unit tests for all processing functionality

### Change Log
- 2025-01-18: Implemented complete Step 5 Processing & Results functionality with CLI orchestration, async processing, progress feedback, log file creation, and post-processing actions
- 2025-01-18: Full integration with existing wizard navigation system and data transfer between steps 
- 2025-01-18: Comprehensive error handling for CLI failures, partial processing scenarios, and file system issues
- 2025-01-18: Cross-platform support for OS shell integration (Open Folder and Open Log functionality)
- 2025-01-18: Fixed all unit tests - comprehensive test coverage with 16/16 tests passing for ProcessingResultsViewModel

### Status
Done