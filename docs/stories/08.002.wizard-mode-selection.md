# Story 08.002: Wizard Mode Selection

## User Story
As a **template processing user**,
I want **to choose between creating a new project or updating an existing project at the start of the wizard**,
So that **I can either process fresh templates or complete partially filled templates**.

## Context
Users need two distinct workflows:
1. **Nova zakazka** (New Project) - The current existing flow for processing fresh templates
2. **Uprava zakazky** (Project Update) - For completing templates that were previously processed but had unfilled placeholders

The mode selection should appear before the current Step 1 (template selection), making the current 5-step wizard into a 6-step process starting with mode selection.

## Acceptance Criteria
1. New initial step (Step 0) presents mode selection before existing workflow
2. **Mode 1: "Nova zakazka"** leads to existing template selection workflow (current Steps 1-5)
3. **Mode 2: "Uprava zakazky"** leads to new folder selection and placeholder completion workflow
4. Mode selection affects step counter display (1 of 6 vs current 1 of 5)
5. Czech language labels and descriptions for both modes
6. Clear visual distinction between the two mode options
7. Mode selection persists in wizard state for subsequent steps

## Mode 2 Workflow Details
### Step 1 (Mode 2): Output Folder Selection
- User selects existing output folder containing partially processed templates
- Folder validation ensures it contains .docx files
- Error handling for invalid or empty folders

### Step 2 (Mode 2): Placeholder Discovery
- Execute `scan` CLI command on selected folder
- Parse JSON output to identify remaining unfilled placeholders
- Filter out `{{SOUBOR_PREFIX}}` placeholder (not applicable for updates)
- Display discovered placeholders for user confirmation

### Step 3 (Mode 2): Placeholder Value Input
- Similar to existing Step 3 but without `{{SOUBOR_PREFIX}}`
- Input form for remaining placeholders only
- Validation ensures all required values are provided

### Step 4 (Mode 2): Processing Execution
- Execute `replace` CLI command directly on selected folder
- No file copying required (templates already in target location)
- Progress display and result summary
- Error handling for replacement failures

## Technical Approach
### UI Changes Only
- **No CLI modifications required** - leverage existing commands
- Create new `ModeSelectionViewModel` and `ModeSelectionView`
- Extend `WizardViewModel` to handle dual workflows
- Update step navigation to accommodate 6-step process for Mode 1

### Workflow Routing
```csharp
public enum ProcessingMode
{
    NewProject,     // Nova zakazka
    UpdateProject   // Uprava zakazky
}

// In WizardViewModel
public ProcessingMode SelectedMode { get; set; }
public int TotalSteps => SelectedMode == ProcessingMode.NewProject ? 6 : 5;
```

### CLI Integration
- **Mode 1**: Uses existing CLI commands (list-sets, discover, scan, copy, replace)
- **Mode 2**: Uses scan and replace commands only
  ```bash
  # Step 2: Discover remaining placeholders
  scan "selected-output-folder" --format json
  
  # Step 4: Replace in existing files
  replace "selected-output-folder" --mapping placeholder-values.json
  ```

## UI Design Pattern
### Step 0: Mode Selection
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Procesor Å¡ablon DOCX - VÃ½bÄ›r reÅ¾imu   â”‚  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Vyberte reÅ¾im zpracovÃ¡nÃ­:              â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ†• Nova zakazka                   â”‚ â”‚
â”‚  â”‚  ZpracovÃ¡nÃ­ novÃ½ch Å¡ablon          â”‚ â”‚  
â”‚  â”‚  â€¢ VÃ½bÄ›r sady Å¡ablon               â”‚ â”‚
â”‚  â”‚  â€¢ KompletnÃ­ workflow              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  âœï¸ Uprava zakazky                 â”‚ â”‚
â”‚  â”‚  DokonÄenÃ­ ÄÃ¡steÄnÄ› vyplnÄ›nÃ½ch     â”‚ â”‚
â”‚  â”‚  â€¢ VÃ½bÄ›r vÃ½stupnÃ­ sloÅ¾ky           â”‚ â”‚  
â”‚  â”‚  â€¢ DoplnÄ›nÃ­ chybÄ›jÃ­cÃ­ch hodnot     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚                          [DalÅ¡Ã­]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Details
### New Components Required
1. **ModeSelectionViewModel**: Handles mode selection logic and validation
2. **ModeSelectionView**: UI for mode selection with radio buttons or tiles
3. **OutputFolderSelectionViewModel**: For Mode 2 folder selection
4. **OutputFolderSelectionView**: File/folder picker UI for Mode 2

### Modified Components
1. **WizardViewModel**: Extended to handle dual workflows and routing
2. **Step navigation**: Updated to accommodate variable step counts
3. **Progress indicators**: Dynamic step counting based on selected mode

### Service Extensions
```csharp
public interface IOutputFolderValidationService
{
    Task<bool> ValidateOutputFolderAsync(string folderPath);
    Task<int> CountDocxFilesAsync(string folderPath);
}
```

## Czech Language Strings
```csharp
// Mode Selection
"Vyberte reÅ¾im zpracovÃ¡nÃ­:" // Select processing mode:
"Nova zakazka" // New Project  
"ZpracovÃ¡nÃ­ novÃ½ch Å¡ablon" // Processing new templates
"Uprava zakazky" // Project Update
"DokonÄenÃ­ ÄÃ¡steÄnÄ› vyplnÄ›nÃ½ch" // Complete partially filled

// Mode 2 Steps
"Vyberte vÃ½stupnÃ­ sloÅ¾ku" // Select output folder
"SloÅ¾ka s ÄÃ¡steÄnÄ› zpracovanÃ½mi Å¡ablonami" // Folder with partially processed templates
"NalezenÃ© nevyplnÄ›nÃ© promÄ›nnÃ©" // Found unfilled placeholders
"DokonÄenÃ­ zpracovÃ¡nÃ­" // Complete processing
```

## Edge Cases
1. **Mode 2 folder has no .docx files**: Clear error message with guidance
2. **No unfilled placeholders found**: Success message - "All placeholders already filled"
3. **Scan command fails**: Graceful error handling with retry option
4. **Replace command fails**: Detailed error reporting with recovery suggestions
5. **User switches modes**: Reset wizard state appropriately

## Definition of Done
- [ ] Mode selection step (Step 0) implemented and functional
- [ ] Mode 1 preserves existing 5-step workflow (now Steps 1-5)
- [ ] Mode 2 implements 4-step workflow for project updates
- [ ] Czech localization for all new UI elements
- [ ] Folder validation and error handling for Mode 2
- [ ] CLI integration uses existing scan and replace commands
- [ ] Step counter dynamically adjusts based on selected mode
- [ ] Navigation flows correctly between modes and steps
- [ ] Comprehensive testing covers both workflow paths
- [ ] No changes required to CLI - pure GUI enhancement

## Testing Strategy
1. **Unit Tests**: Mode selection logic, workflow routing, validation services
2. **Integration Tests**: CLI command execution for both modes
3. **UI Tests**: Mode selection interaction, step navigation flow
4. **E2E Tests**: Complete workflows for both Nova zakazka and Uprava zakazky
5. **Error Scenario Tests**: Invalid folders, CLI failures, edge cases