# Story 08.002: Wizard Mode Selection

## User Story
As a **template processing user**,
I want **to choose between creating a new project or updating an existing project at the start of the wizard**,
So that **I can either process fresh templates or complete partially filled templates**.

## Context
Users need two distinct workflows:
1. **Nova zakazka** (New Project) - The current existing flow for processing fresh templates
2. **Uprava zakazky** (Project Update) - For completing templates that were previously processed but had unfilled placeholders

The mode selection should appear before the current Step 1 (template selection), making the current 5-step wizard into a 6-step process starting with mode selection.

## Acceptance Criteria
1. New initial step (Step 0) presents mode selection before existing workflow
2. **Mode 1: "Nova zakazka"** leads to existing template selection workflow (current Steps 1-5)
3. **Mode 2: "Uprava zakazky"** leads to new folder selection and placeholder completion workflow
4. Mode selection affects step counter display (1 of 6 vs current 1 of 5)
5. Czech language labels and descriptions for both modes
6. Clear visual distinction between the two mode options
7. Mode selection persists in wizard state for subsequent steps

## Mode 2 Workflow Details
### Step 1 (Mode 2): Output Folder Selection
- User selects existing output folder containing partially processed templates
- Folder validation ensures it contains .docx files
- Error handling for invalid or empty folders

### Step 2 (Mode 2): Placeholder Discovery
- Use `IPlaceholderScanService` to scan selected folder for remaining placeholders
- Identify remaining unfilled placeholders from discovered templates
- Filter out `{{SOUBOR_PREFIX}}` placeholder (not applicable for updates)
- Display discovered placeholders for user confirmation

### Step 3 (Mode 2): Placeholder Value Input
- Similar to existing Step 3 but without `{{SOUBOR_PREFIX}}`
- Input form for remaining placeholders only
- Validation ensures all required values are provided

### Step 4 (Mode 2): Processing Execution
- Use `IPlaceholderReplaceService` directly on templates in selected folder
- No file copying required (templates already in target location)
- Progress display and result summary
- Error handling for replacement failures

## Technical Approach
### GUI Service Integration
- **Direct service usage** - leverage existing Core services in GUI
- Create new `ModeSelectionViewModel` and `ModeSelectionView`
- Extend `WizardViewModel` to handle dual workflows
- Update step navigation to accommodate 6-step process for Mode 1

### Workflow Routing
```csharp
public enum ProcessingMode
{
    NewProject,     // Nova zakazka
    UpdateProject   // Uprava zakazky
}

// In WizardViewModel
public ProcessingMode SelectedMode { get; set; }
public int TotalSteps => SelectedMode == ProcessingMode.NewProject ? 6 : 5;
```

### Service Integration
- **Mode 1**: Uses existing Core services (ITemplateSetService, ITemplateDiscoveryService, IPlaceholderScanService, ITemplateCopyService, IPlaceholderReplaceService)
- **Mode 2**: Uses IPlaceholderScanService and IPlaceholderReplaceService directly
  ```csharp
  // Step 2: Discover remaining placeholders
  var scanResult = await _placeholderScanService.ScanDirectoryAsync(selectedOutputFolder);
  
  // Step 4: Replace in existing files
  await _placeholderReplaceService.ReplaceInDirectoryAsync(selectedOutputFolder, placeholderValues);
  ```

## UI Design Pattern
### Step 0: Mode Selection
```
┌─────────────────────────────────────────┐
│  Procesor šablon DOCX - Výběr režimu   │  
├─────────────────────────────────────────┤
│                                         │
│  Vyberte režim zpracování:              │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │  🆕 Nova zakazka                   │ │
│  │  Zpracování nových šablon          │ │  
│  │  • Výběr sady šablon               │ │
│  │  • Kompletní workflow              │ │
│  └─────────────────────────────────────┘ │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │  ✏️ Uprava zakazky                 │ │
│  │  Dokončení částečně vyplněných     │ │
│  │  • Výběr výstupní složky           │ │  
│  │  • Doplnění chybějících hodnot     │ │
│  └─────────────────────────────────────┘ │
│                                         │
│                          [Další]       │
└─────────────────────────────────────────┘
```

## Implementation Details
### New Components Required
1. **ModeSelectionViewModel**: Handles mode selection logic and validation
2. **ModeSelectionView**: UI for mode selection with radio buttons or tiles
3. **OutputFolderSelectionViewModel**: For Mode 2 folder selection
4. **OutputFolderSelectionView**: File/folder picker UI for Mode 2

### Modified Components
1. **WizardViewModel**: Extended to handle dual workflows and routing
2. **Step navigation**: Updated to accommodate variable step counts
3. **Progress indicators**: Dynamic step counting based on selected mode

### Service Extensions
```csharp
public interface IOutputFolderValidationService
{
    Task<bool> ValidateOutputFolderAsync(string folderPath);
    Task<int> CountDocxFilesAsync(string folderPath);
}
```

## Czech Language Strings
```csharp
// Mode Selection
"Vyberte režim zpracování:" // Select processing mode:
"Nova zakazka" // New Project  
"Zpracování nových šablon" // Processing new templates
"Uprava zakazky" // Project Update
"Dokončení částečně vyplněných" // Complete partially filled

// Mode 2 Steps
"Vyberte výstupní složku" // Select output folder
"Složka s částečně zpracovanými šablonami" // Folder with partially processed templates
"Nalezené nevyplněné proměnné" // Found unfilled placeholders
"Dokončení zpracování" // Complete processing
```

## Edge Cases
1. **Mode 2 folder has no .docx files**: Clear error message with guidance
2. **No unfilled placeholders found**: Success message - "All placeholders already filled"
3. **Scan service fails**: Graceful error handling with retry option
4. **Replace service fails**: Detailed error reporting with recovery suggestions
5. **User switches modes**: Reset wizard state appropriately

## Definition of Done
- [ ] Mode selection step (Step 0) implemented and functional
- [ ] Mode 1 preserves existing 5-step workflow (now Steps 1-5)
- [ ] Mode 2 implements 4-step workflow for project updates
- [ ] Czech localization for all new UI elements
- [ ] Folder validation and error handling for Mode 2
- [ ] Service integration uses existing Core services directly
- [ ] Step counter dynamically adjusts based on selected mode
- [ ] Navigation flows correctly between modes and steps
- [ ] Comprehensive testing covers both workflow paths
- [ ] No changes required to Core services - pure GUI enhancement

## Tasks
- [x] **Task 1**: Create ProcessingMode enum and update WizardViewModel
  - [x] Add ProcessingMode enum (NewProject, UpdateProject)
  - [x] Add SelectedMode property to WizardViewModel
  - [x] Update TotalSteps property to return 6 for NewProject, 5 for UpdateProject
- [x] **Task 2**: Create ModeSelectionViewModel and View
  - [x] Implement ModeSelectionViewModel with mode selection logic
  - [x] Create ModeSelectionView with Czech UI labels
  - [x] Add navigation to next step based on selected mode
- [x] **Task 3**: Create OutputFolderSelectionViewModel and View for Mode 2
  - [x] Implement ExistingProjectFolderSelectionViewModel with folder validation
  - [x] Create Step1ExistingProjectFolderSelectionView with folder picker
  - [x] Add folder validation logic (integrated into ViewModel)
- [x] **Task 4**: Update WizardViewModel for dual workflow routing
  - [x] Add logic to route to appropriate next step based on mode
  - [x] Update step navigation to handle variable step counts
  - [x] Ensure wizard state resets when mode changes
- [x] **Task 5**: Implement Mode 2 placeholder discovery workflow
  - [x] Integrate IPlaceholderScanService for folder scanning
  - [x] Filter out {{SOUBOR_PREFIX}} placeholder
  - [x] Create placeholder confirmation UI for Mode 2
- [ ] **Task 6**: Implement Mode 2 processing execution
  - [ ] Use IPlaceholderReplaceService for in-place replacement
  - [ ] Add progress display and error handling
  - [ ] Skip file copying for Mode 2 workflow
- [x] **Task 7**: Create comprehensive tests
  - [x] Create another HappyCase E2E test - you can continue with the existing one - leave some placeholder not filled in and use the new mode to fill it in all the files
  - [x] Unit tests for all new ViewModels
  - [x] Integration tests for service usage
  - [ ] UI tests for mode selection and navigation

## Testing Strategy
1. **Unit Tests**: Mode selection logic, workflow routing, validation services
2. **Integration Tests**: Service execution for both modes
3. **UI Tests**: Mode selection interaction, step navigation flow
4. **E2E Tests**: Complete workflows for both Nova zakazka and Uprava zakazky
5. **Error Scenario Tests**: Invalid folders, service failures, edge cases

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Status
In Progress

### Debug Log References
- Initial story analysis completed
- Tasks created based on requirements

### Completion Notes
- 

### File List
- src/DocxTemplate.UI/Models/ProcessingMode.cs (new)
- src/DocxTemplate.UI/ViewModels/WizardViewModel.cs (modified)
- src/DocxTemplate.UI/ViewModels/ModeSelectionViewModel.cs (new)
- src/DocxTemplate.UI/ViewModels/ExistingProjectFolderSelectionViewModel.cs (new)
- src/DocxTemplate.UI/Views/Steps/Step0ModeSelectionView.axaml (new)
- src/DocxTemplate.UI/Views/Steps/Step0ModeSelectionView.axaml.cs (new)
- src/DocxTemplate.UI/Views/Steps/Step1ExistingProjectFolderSelectionView.axaml (new)
- src/DocxTemplate.UI/Views/Steps/Step1ExistingProjectFolderSelectionView.axaml.cs (new)
- src/DocxTemplate.UI/ServiceRegistration.cs (modified)
- tests/DocxTemplate.UI.Tests/Helpers/TestServiceProviderFactory.cs (new)
- tests/DocxTemplate.UI.Tests/ViewModels/WizardViewModelProcessingModeTests.cs (new)
- tests/DocxTemplate.UI.Tests/ViewModels/ExistingProjectFolderSelectionViewModelTests.cs (new)

### Change Log
- Initial task breakdown created
