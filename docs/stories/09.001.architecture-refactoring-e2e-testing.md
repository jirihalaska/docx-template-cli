# Story 09.001: Architecture Refactoring and Comprehensive E2E Testing

## User Story
As a **UI developer**,
I want **to remove the CLI layer dependency from the UI and implement direct Core/Infrastructure service integration with comprehensive E2E testing**,
So that **I can have a simpler, more maintainable architecture with robust testing that validates the complete user workflow**.

## Context
The current architecture uses a three-layer approach where the UI communicates with CLI through process execution:
- **DocxTemplate.CLI** - Command-line interface layer with System.CommandLine
- **DocxTemplate.Core** - Business logic with service interfaces and domain models  
- **DocxTemplate.Infrastructure** - Concrete service implementations
- **DocxTemplate.UI** - Avalonia GUI that executes CLI processes and parses JSON responses

### Current Issues
1. **Process Overhead**: UI spawns CLI processes and parses JSON, adding latency and complexity
2. **Fragile Integration**: Manual CLI argument construction and JSON parsing in `PlaceholderDiscoveryViewModel:207-210`
3. **Complex Build Process**: MSBuild targets embed CLI executable into UI distribution
4. **Testing Limitations**: Hard to mock CLI dependencies, process boundaries complicate testing
5. **Error Handling**: CLI errors must be parsed from text output instead of direct exception handling

### Benefits of Direct Service Integration
1. **Performance**: Eliminate process startup overhead and JSON marshalling
2. **Better Error Handling**: Direct exception handling instead of parsing CLI error output
3. **Simpler Deployment**: No CLI executable embedding required
4. **Better Testing**: Dependency injection allows easy mocking and integration testing
5. **Reduced Complexity**: Remove CLI service classes and JSON parsing logic

### Trade-offs
- **Standalone CLI Access**: Users lose command-line automation capability (but CLI project remains for separate distribution)
- **Build Simplification**: Remove complex MSBuild targets for CLI embedding

## Task Breakdown

### Task 1: Remove CLI Dependencies and Add Infrastructure References
**Goal**: Update project references and remove CLI-related dependencies
**Estimated Effort**: 2 hours

- Update `DocxTemplate.UI.csproj` to add direct Infrastructure project reference
- Remove CLI build/copy targets and CLI executable embedding logic
- Remove CLI service registrations from DI container
- Remove CLI-related service classes: `CliCommandBuilder`, `CliCommandServiceFactory`, `CliExecutableDiscoveryService`, `LazyCliCommandService`
- Remove CLI response models: `CliScanResponse`

**Acceptance Criteria**:
- UI project builds without CLI dependencies
- No CLI processes spawned during UI operations
- All CLI-related files removed from UI project

---

### Task 2: Register Infrastructure Services Directly  
**Goal**: Replace CLI service layer with direct Infrastructure service registration
**Estimated Effort**: 3 hours

- Update `ServiceRegistration.cs` to register Infrastructure services directly
- Add service registrations: `ITemplateDiscoveryService`, `IPlaceholderScanService`, `ITemplateCopyService`, `IPlaceholderReplaceService`, `IFileSystemService`
- Update ViewModels constructor injection to use Core service interfaces
- Remove `ICliCommandService` and related CLI interfaces

**Acceptance Criteria**:
- All Infrastructure services properly registered in DI container
- ViewModels receive Core services through constructor injection
- Application starts without DI resolution errors

---

### Task 3: Refactor PlaceholderDiscoveryViewModel
**Goal**: Replace CLI execution with direct service calls for placeholder discovery
**Estimated Effort**: 4 hours

- Replace CLI process execution with `IPlaceholderScanService` calls
- Remove JSON parsing logic and CLI command building
- Update discovery logic to work with Core domain models (`PlaceholderScanResult`, `Placeholder`)
- Maintain identical UI behavior and Czech localization
- Test placeholder discovery functionality manually

**Acceptance Criteria**:
- Placeholder discovery works without CLI process spawning
- UI displays same placeholder information as before
- Czech localization preserved
- Performance improved (no process overhead)

---

### Task 4: Refactor ProcessingResultsViewModel
**Goal**: Replace CLI execution with direct service calls for template processing
**Estimated Effort**: 4 hours

- Replace CLI execution with `ITemplateCopyService` and `IPlaceholderReplaceService`
- Remove JSON response parsing for processing results
- Update processing logic to work directly with Core services
- Maintain progress reporting and error handling
- Test complete processing workflow manually

**Acceptance Criteria**:
- Template processing works without CLI processes
- Progress reporting functions correctly
- Error handling shows appropriate messages in Czech
- Output files generated with correct structure and naming

---

### Task 5: Create E2E Test Project Foundation
**Goal**: Set up Avalonia.Headless test infrastructure
**Estimated Effort**: 3 hours

- Create `tests/DocxTemplate.UI.Tests` project with Avalonia.Headless.XUnit
- Add project references to UI, Core, and Infrastructure projects
- Create test output directory structure: `./test-output/e2e/`
- Add `.gitignore` entry for test-output directory
- Create base test classes: `E2ETestBase` with test output management

**Acceptance Criteria**:
- Test project builds successfully
- Avalonia.Headless integration functional
- Test output directory structure created
- Base test infrastructure ready for test implementation

---

### Task 6: Create Test Helper Infrastructure
**Goal**: Build reusable test helpers for UI automation and document validation
**Estimated Effort**: 4 hours

- Create `AvaloniaTestHelpers` class with UI control interaction methods
- Create `DocumentContentValidator` class for DOCX content verification
- Implement helper methods: `FindControl`, `WaitFor`, `SimulateClick`, `SimulateTextInput`
- Implement validation methods: `ScanDocumentAsync`, `ValidateNoPlaceholders`, `ValidateCzechCharacters`
- Test helper methods with simple validation scenarios

**Acceptance Criteria**:
- Helper classes provide reliable UI automation
- Document validation can verify placeholder replacement
- Czech character validation works correctly
- Helper methods are well-tested and stable

---

### Task 7: Implement Happy Path E2E Test
**Goal**: Create comprehensive end-to-end test validating complete user workflow
**Estimated Effort**: 6 hours

- Implement `CompleteWorkflow_WithCzechCharacters_ProducesCorrectOutput` test
- Use real template files from `./templates/01 VZOR Užší řízení`
- Test all UI steps: template selection, placeholder discovery, input, output selection, processing
- Validate Czech character handling: "Žádost č. 123", "Město Břeclav", etc.
- Verify SOUBOR_PREFIX functionality in file naming
- Include comprehensive output validation

**Acceptance Criteria**:
- Complete workflow test passes on Windows and macOS
- All UI steps validated programmatically
- Czech characters preserved throughout processing
- Output files match expected structure and naming
- Test produces detailed validation report

---

### Task 8: Implement Error Handling Tests
**Goal**: Create tests for error scenarios and edge cases
**Estimated Effort**: 4 hours

- Test missing template directories scenario
- Test invalid placeholder patterns handling
- Test write-protected output directories
- Test partial processing failures
- Test document corruption scenarios
- Verify Czech error messages displayed correctly

**Acceptance Criteria**:
- Error scenarios handled gracefully
- Error messages displayed in Czech
- Application remains stable during error conditions
- Recovery mechanisms work properly

---

### Task 9: Performance and Integration Tests
**Goal**: Validate performance and multi-scenario processing
**Estimated Effort**: 3 hours

- Test large template sets processing
- Test multiple placeholder replacement scenarios
- Validate memory usage with large documents
- Compare processing times before/after refactoring
- Test concurrent processing scenarios

**Acceptance Criteria**:
- Performance maintained or improved after refactoring
- Large document processing works reliably
- Memory usage remains reasonable
- Processing times documented and acceptable

---

### Task 10: Update CI/CD and Documentation
**Goal**: Integrate E2E tests into build pipeline and update documentation
**Estimated Effort**: 2 hours

- Update CI/CD pipeline to run E2E tests on Windows and macOS
- Configure test artifact archival for manual inspection
- Update documentation to reflect new architecture
- Update CLI reference documentation if needed

**Acceptance Criteria**:
- CI/CD pipeline runs E2E tests successfully
- Test artifacts archived for review
- Documentation reflects current architecture
- Build process simplified and reliable

## Acceptance Criteria

### Phase 1: Architecture Refactoring
1. **Direct Service Integration**
   - UI project references DocxTemplate.Infrastructure directly
   - Remove all CLI process execution and JSON parsing
   - Replace `ICliCommandService` with direct Core service interfaces
   - Remove CLI-related service classes from UI project

2. **Dependency Injection Updates**
   - Register Infrastructure services directly in UI DI container
   - Remove CLI service factory and discovery services
   - Update ViewModels to use Core services through constructor injection

3. **ViewModel Refactoring**
   - `PlaceholderDiscoveryViewModel`: Use `IPlaceholderScanService` instead of CLI execution
   - `ProcessingResultsViewModel`: Use `ITemplateCopyService` and `IPlaceholderReplaceService`
   - Remove JSON parsing and CLI command building logic
   - Maintain identical UI behavior and Czech localization

4. **Build Process Simplification**
   - Remove CLI build/copy targets from DocxTemplate.UI.csproj
   - Remove CLI executable embedding logic
   - Simplify publish scripts to handle UI-only distribution
   - Keep CLI project separate for future standalone use

### Phase 2: Comprehensive E2E Testing Framework

1. **Avalonia.Headless Test Project**
   - Create `DocxTemplate.UI.Tests` project with Avalonia.Headless.XUnit
   - Reference UI, Core, and Infrastructure projects
   - Use real templates from `./templates` directory for authentic testing

2. **Test Infrastructure with Persistent Outputs**
   - Fixed test output directory: `./test-output/e2e/`
   - Clear directory BEFORE each test run (not after) for manual inspection
   - Structure: `./test-output/e2e/{TestName}/{timestamp}/`
   - Include `test-parameters.json` file documenting test inputs
   - Add `.gitignore` entry for test-output directory

3. **Happy Path E2E Test Implementation**
   ```csharp
   [Fact]
   public async Task CompleteWorkflow_WithCzechCharacters_ProducesCorrectOutput()
   ```
   - Use real template files from `./templates/01 VZOR Užší řízení`
   - Test Czech characters: "Žádost č. 123", "Město Břeclav", "Částka 1 500 000 Kč"
   - Test SOUBOR_PREFIX: "{{SOUBOR_PREFIX}}" → "2024_12_TestováníČeština"
   - Verify each step's UI display content matches expectations

4. **Step-by-Step UI Validation**
   - **Step 1**: Verify template sets "01 VZOR Užší řízení" and "02 VZOR Jiné řizené" displayed
   - **Step 2**: Verify placeholder count and names in discovery results
   - **Step 3**: Verify input fields generated for each discovered placeholder
   - **Step 4**: Verify output path selection functionality
   - **Step 5**: Verify processing status messages and completion indicators

5. **Output Validation Requirements**
   - **Folder Structure**: Verify output preserves template subdirectory structure
   - **File Naming**: Verify files include prefix: "2024_12_TestováníČeština_Výzva k podání nabídky (II. kolo).docx"
   - **Content Verification**: Scan output documents to verify placeholder replacement
   - **Czech Character Preservation**: Ensure Czech characters maintained in processed documents
   - **Complete Replacement**: Verify no unfilled placeholders remain in output

### Phase 3: Test Scenarios and Edge Cases

1. **Error Handling Tests**
   - Missing template directories
   - Invalid placeholder patterns
   - Write-protected output directories  
   - Partial processing failures
   - Document corruption scenarios

2. **Czech Localization Tests**
   - UI messages remain in Czech after refactoring
   - Czech characters in placeholder values processed correctly
   - Error messages displayed in Czech
   - File paths with Czech characters handled properly

3. **Performance and Integration Tests**
   - Large template sets processing
   - Multiple placeholder replacement scenarios
   - Concurrent processing validation
   - Memory usage with large documents

## Technical Approach

### Architecture Changes
```csharp
// Before: UI → CLI Process → Core Services
PlaceholderDiscoveryViewModel → ICliCommandService → CLI Process → JSON Parsing

// After: UI → Core Services Directly  
PlaceholderDiscoveryViewModel → IPlaceholderScanService → Direct Method Calls
```

### Service Registration Updates
```csharp
// Remove CLI services
services.AddTransient<ICliExecutableDiscoveryService, CliExecutableDiscoveryService>();
services.AddTransient<ICliCommandService, LazyCliCommandService>();

// Add Infrastructure services directly
services.AddSingleton<ITemplateDiscoveryService, TemplateDiscoveryService>();
services.AddSingleton<IPlaceholderScanService, PlaceholderScanService>();
services.AddSingleton<ITemplateCopyService, TemplateCopyService>();
services.AddSingleton<IPlaceholderReplaceService, PlaceholderReplaceService>();
services.AddSingleton<IFileSystemService, FileSystemService>();
```

### Test Helper Infrastructure
```csharp
public static class AvaloniaTestHelpers
{
    public static async Task<T> FindControl<T>(this Visual root, string name) where T : Control;
    public static async Task WaitFor(Func<bool> condition, int timeout = 5000);
    public static async Task SimulateClick(Button button);
    public static async Task SimulateTextInput(TextBox textBox, string text);
}

public static class DocumentContentValidator  
{
    public static async Task<PlaceholderScanResult> ScanDocumentAsync(string filePath);
    public static async Task<bool> ValidateNoPlaceholders(string filePath);
    public static async Task<bool> ValidateCzechCharacters(string filePath, string expectedContent);
}
```

### Test Output Management
```csharp
public class E2ETestBase
{
    protected string SetupTestOutput(string testName)
    {
        var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
        var testOutput = Path.Combine("./test-output/e2e", testName, timestamp);
        
        // Clear previous runs for this test
        var testDir = Path.Combine("./test-output/e2e", testName);
        if (Directory.Exists(testDir))
            Directory.Delete(testDir, recursive: true);
            
        Directory.CreateDirectory(testOutput);
        return testOutput;
    }
}
```

## Implementation Details

### Files to Modify
1. **DocxTemplate.UI.csproj**: Add Infrastructure reference, remove CLI build targets
2. **ServiceRegistration.cs**: Replace CLI services with Infrastructure services
3. **PlaceholderDiscoveryViewModel.cs**: Replace CLI execution with `IPlaceholderScanService`
4. **ProcessingResultsViewModel.cs**: Replace CLI execution with direct services
5. **WizardViewModel.cs**: Update service dependencies

### Files to Remove
1. **Services/CliCommandBuilder.cs**
2. **Services/CliCommandServiceFactory.cs** 
3. **Services/CliExecutableDiscoveryService.cs**
4. **Services/LazyCliCommandService.cs**
5. **Models/CliScanResponse.cs**

### Files to Create
1. **tests/DocxTemplate.UI.Tests/DocxTemplate.UI.Tests.csproj**
2. **tests/DocxTemplate.UI.Tests/E2E/HappyPathE2ETest.cs**
3. **tests/DocxTemplate.UI.Tests/Helpers/AvaloniaTestHelpers.cs**
4. **tests/DocxTemplate.UI.Tests/Helpers/DocumentContentValidator.cs**
5. **test-output/.gitignore**

## Testing Strategy

### Avalonia.Headless Integration
```csharp
[Collection("UI Tests")]
public class HappyPathE2ETest : E2ETestBase
{
    [Fact]
    public async Task CompleteWorkflow_WithRealTemplates_ProducesValidOutput()
    {
        // Arrange
        var testOutput = SetupTestOutput("HappyPath_Czech");
        var services = SetupServices();
        
        using var app = AvaloniaApp.BuildAvaloniaApp().UseHeadless();
        var window = CreateMainWindow(services);
        
        // Act & Assert - Step by step validation
        await ValidateStep1_TemplateSelection(window);
        await ValidateStep2_PlaceholderDiscovery(window);  
        await ValidateStep3_PlaceholderInput(window, czechTestValues);
        await ValidateStep4_OutputSelection(window, testOutput);
        await ValidateStep5_Processing(window);
        
        // Verify final output
        await ValidateOutputStructure(testOutput);
        await ValidateFileNaming(testOutput, "2024_12_TestováníČeština");
        await ValidatePlaceholderReplacement(testOutput);
        await ValidateCzechCharacters(testOutput);
        
        TestContext.WriteLine($"Test output: {Path.GetFullPath(testOutput)}");
    }
}
```

### CI/CD Integration
```yaml
name: E2E Tests
jobs:
  ui-tests:
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Run E2E Tests
        run: dotnet test tests/DocxTemplate.UI.Tests --logger trx
      - name: Archive Test Outputs
        uses: actions/upload-artifact@v3
        with:
          name: test-outputs-${{ matrix.os }}
          path: test-output/e2e/
          retention-days: 30
```

## Czech Language Test Data
```csharp
private static readonly Dictionary<string, string> CzechTestValues = new()
{
    {"SOUBOR_PREFIX", "2024_12_TestováníČeština"},
    {"NÁZEV_ZAKÁZKY", "Rekonstrukce náměstí v Břeclavi"},
    {"ZADAVATEL", "Město Břeclav"},
    {"ČÁSTKA_ZAKÁZKY", "1 500 000 Kč"},
    {"DATUM_ZADÁNÍ", "15. prosince 2024"},
    {"ODPOVĚDNÁ_OSOBA", "Ing. Jana Nováková, Ph.D."},
    {"ADRESA_ZADAVATELE", "Nám. T.G. Masaryka 1, 690 02 Břeclav"}
};
```

## Expected Template Structure
Based on discovered templates in `./templates`:
```
templates/
├── 01 VZOR Užší řízení/
│   ├── 3. Vysvětlení ZD/
│   │   └── Vysvetleni ZD 1.docx
│   ├── 5. Výzvy k objasnění ŽoÚ/
│   │   └── Výzva k objasnění žádosti.docx
│   ├── 7. Výzva k podání nabídek/
│   │   └── Výzva k podání nabídky (II. kolo).docx
│   ├── 9. Zpráva o hodnocení, Oznámení o výběru/
│   │   └── [multiple files]
│   └── 11. Závěrečné úkony/
│       └── Pisemna zprava zadavatele.docx
└── 02 VZOR Jiné řizené/
    └── [similar structure]
```

## Definition of Done
- [ ] UI project directly references Infrastructure services without CLI dependency
- [ ] All ViewModels refactored to use Core services through dependency injection
- [ ] CLI-related service classes removed from UI project
- [ ] Build process simplified - no CLI executable embedding
- [ ] Comprehensive E2E test project created with Avalonia.Headless
- [ ] Happy path test validates complete workflow with Czech characters
- [ ] SOUBOR_PREFIX functionality verified in file naming and content
- [ ] Test outputs preserved in fixed directory for manual inspection
- [ ] Output folder structure and file naming validated
- [ ] Placeholder replacement verification in generated documents
- [ ] Czech character preservation confirmed in processed content
- [ ] Error scenario tests implemented
- [ ] CI/CD pipeline updated to run E2E tests and archive outputs
- [ ] Documentation updated to reflect new architecture
- [ ] All tests pass on Windows and macOS
- [ ] Manual inspection confirms output quality matches expectations

## Risk Mitigation
1. **CLI Dependency**: Keep CLI project intact for future standalone distribution
2. **Testing Complexity**: Start with simple happy path, incrementally add edge cases  
3. **Czech Character Issues**: Explicit validation of encoding throughout pipeline
4. **Performance Regression**: Compare processing times before/after refactoring
5. **UI Behavior Changes**: Maintain identical user experience during refactoring