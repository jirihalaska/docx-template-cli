# Task 10.002.03: Image Processing Infrastructure

## Task Overview
Set up image processing infrastructure using SkiaSharp for loading images and calculating display dimensions.

## Prerequisites
- NuGet package: SkiaSharp (cross-platform image processing)
- Understanding of image aspect ratio calculations

## Implementation Steps

### 1. Add SkiaSharp Dependencies
**File:** `src/DocxTemplate.Infrastructure/DocxTemplate.Infrastructure.csproj`
```xml
<PackageReference Include="SkiaSharp" Version="2.88.8" />
<PackageReference Include="SkiaSharp.NativeAssets.Linux" Version="2.88.8" />
<PackageReference Include="SkiaSharp.NativeAssets.macOS" Version="2.88.8" />
<PackageReference Include="SkiaSharp.NativeAssets.Win32" Version="2.88.8" />
```

### 2. Create Image Processing Service
**File:** `src/DocxTemplate.Infrastructure/Images/ImageProcessor.cs`

```csharp
public class ImageProcessor : IImageProcessor
{
    public ImageInfo GetImageInfo(string imagePath)
    {
        using var image = SKBitmap.Decode(imagePath);
        return new ImageInfo
        {
            Width = image.Width,
            Height = image.Height,
            Format = DetectFormat(imagePath)
        };
    }
}
```

### 3. Implement Aspect Ratio Calculator
**File:** `src/DocxTemplate.Infrastructure/Images/AspectRatioCalculator.cs`

**CRITICAL:** Only calculate DISPLAY dimensions, never resize actual image data:
```csharp
public (int width, int height) CalculateDisplayDimensions(
    int originalWidth, int originalHeight, 
    int maxWidth, int maxHeight)
{
    // "contain" mode - fit within bounds preserving aspect ratio
    double scaleWidth = (double)maxWidth / originalWidth;
    double scaleHeight = (double)maxHeight / originalHeight;
    double scale = Math.Min(scaleWidth, scaleHeight);
    
    return ((int)(originalWidth * scale), (int)(originalHeight * scale));
}
```

### 4. Create Image Type Detector
**File:** `src/DocxTemplate.Infrastructure/Images/ImageTypeDetector.cs`
```csharp
public ImagePartType GetImagePartType(string imagePath)
{
    var extension = Path.GetExtension(imagePath).ToLower();
    return extension switch
    {
        ".png" => ImagePartType.Png,
        ".jpg" or ".jpeg" => ImagePartType.Jpeg,
        ".gif" => ImagePartType.Gif,
        ".bmp" => ImagePartType.Bmp,
        _ => throw new NotSupportedException($"Image type {extension} not supported")
    };
}
```

### 5. Implement Pixel to EMU Converter
**File:** `src/DocxTemplate.Infrastructure/Images/UnitConverter.cs`
```csharp
public static class UnitConverter
{
    private const int EmusPerPixel = 9525;
    
    public static long PixelsToEmus(int pixels)
    {
        return (long)pixels * EmusPerPixel;
    }
}
```

## Error Handling
- Invalid image file paths
- Corrupted image files
- Unsupported image formats
- Zero or negative dimensions

## Unit Tests Required
- Test image info extraction for various formats
- Test aspect ratio calculations (contain mode)
- Test pixel to EMU conversion
- Test image format detection
- Test error handling for invalid images

## Success Criteria
- [x] SkiaSharp integrated successfully
- [x] Image dimensions extracted correctly
- [x] Aspect ratio preserved in calculations
- [x] All supported formats detected
- [x] Unit conversions accurate
- [x] Cross-platform compatibility verified

## Estimated Time: 1.5 hours