# Task 10.002.06: Comprehensive Testing Implementation

## Task Overview
Implement unit and integration tests for image placeholder functionality across all layers.

## Prerequisites
- Tasks 10.002.01-05 completed
- Test framework: XUnit
- Mock framework: Moq
- Test images prepared

## Test Structure

### 1. Core Layer Tests
**File:** `tests/DocxTemplate.Core.Tests/Models/ImagePlaceholderTests.cs`

```csharp
public class ImagePlaceholderTests
{
    [Fact]
    public void Placeholder_WithImageType_HasCorrectProperties()
    {
        // arrange
        var placeholder = new Placeholder
        {
            Name = "logo",
            Type = PlaceholderType.Image,
            ImageProperties = new ImageProperties
            {
                MaxWidth = 200,
                MaxHeight = 100,
                ImageName = "logo"
            }
        };
        
        // act
        var isImage = placeholder.Type == PlaceholderType.Image;
        
        // assert
        Assert.True(isImage);
        Assert.Equal(200, placeholder.ImageProperties.MaxWidth);
        Assert.Equal(100, placeholder.ImageProperties.MaxHeight);
    }
    
    [Theory]
    [InlineData("{{image:logo|width:200|height:100}}", true)]
    [InlineData("{{companyName}}", false)]
    [InlineData("{{image:logo}}", false)] // Missing dimensions
    public void PlaceholderPattern_DetectsImageCorrectly(string input, bool shouldBeImage)
    {
        // Test pattern matching
    }
}
```

### 2. Infrastructure Layer Tests
**File:** `tests/DocxTemplate.Infrastructure.Tests/DocxProcessing/ImagePlaceholderScannerTests.cs`

```csharp
public class ImagePlaceholderScannerTests
{
    [Fact]
    public async Task Scanner_DetectsImagePlaceholder_InDocument()
    {
        // arrange
        var scanner = new PlaceholderScanner();
        var testDoc = CreateTestDocumentWithImagePlaceholder();
        
        // act
        var result = await scanner.ScanAsync(testDoc);
        
        // assert
        var imagePlaceholder = result.Placeholders
            .FirstOrDefault(p => p.Type == PlaceholderType.Image);
        Assert.NotNull(imagePlaceholder);
        Assert.Equal("logo", imagePlaceholder.Name);
    }
    
    [Fact]
    public void Scanner_ReconstructsSplitPlaceholder()
    {
        // arrange - create paragraph with split runs
        var paragraph = CreateParagraphWithSplitRuns(
            "{{ima", "ge:logo|wid", "th:200|height:100}}"
        );
        
        // act
        var reconstructed = scanner.ReconstructParagraphText(paragraph);
        
        // assert
        Assert.Equal("{{image:logo|width:200|height:100}}", reconstructed);
    }
}
```

### 3. Image Processing Tests
**File:** `tests/DocxTemplate.Infrastructure.Tests/Images/AspectRatioCalculatorTests.cs`

```csharp
public class AspectRatioCalculatorTests
{
    [Theory]
    [InlineData(1000, 500, 200, 200, 200, 100)] // Landscape to square
    [InlineData(500, 1000, 200, 200, 100, 200)] // Portrait to square
    [InlineData(800, 600, 400, 300, 400, 300)]  // Exact fit
    [InlineData(800, 600, 200, 300, 200, 150)]  // Scale down proportionally
    public void CalculateDisplayDimensions_PreservesAspectRatio(
        int origWidth, int origHeight, 
        int maxWidth, int maxHeight,
        int expectedWidth, int expectedHeight)
    {
        // arrange
        var calculator = new AspectRatioCalculator();
        
        // act
        var (width, height) = calculator.CalculateDisplayDimensions(
            origWidth, origHeight, maxWidth, maxHeight);
        
        // assert
        Assert.Equal(expectedWidth, width);
        Assert.Equal(expectedHeight, height);
    }
}
```

### 4. Image Replacement Tests
**File:** `tests/DocxTemplate.Infrastructure.Tests/DocxProcessing/ImageReplacementTests.cs`

```csharp
public class ImageReplacementTests
{
    [Fact]
    public async Task ReplaceService_InsertsImage_AtPlaceholderLocation()
    {
        // arrange
        var service = new PlaceholderReplaceService();
        var testDoc = CreateDocumentWithImagePlaceholder();
        var imagePath = GetTestImagePath("test-logo.png");
        
        // act
        await service.ReplaceImagePlaceholderAsync(testDoc, "logo", imagePath);
        
        // assert
        var images = testDoc.MainDocumentPart
            .Document.Descendants<Drawing>().Count();
        Assert.Equal(1, images);
    }
    
    [Fact]
    public async Task ReplaceService_PreservesImageQuality()
    {
        // arrange
        var originalBytes = File.ReadAllBytes("test-image.png");
        
        // act
        await service.ReplaceImagePlaceholderAsync(/*...*/);
        
        // assert - verify image bytes unchanged
        var insertedImagePart = GetInsertedImagePart(doc);
        var insertedBytes = GetImageBytes(insertedImagePart);
        Assert.Equal(originalBytes, insertedBytes);
    }
}
```

### 5. UI Integration Tests
**File:** `tests/DocxTemplate.UI.Tests/ViewModels/PlaceholderValueViewModelTests.cs`

```csharp
public class PlaceholderValueViewModelTests
{
    [Fact]
    public void ViewModel_ShowsBrowseButton_ForImagePlaceholder()
    {
        // arrange
        var vm = new PlaceholderValueViewModel
        {
            Type = PlaceholderType.Image,
            Name = "logo"
        };
        
        // act & assert
        Assert.True(vm.IsImagePlaceholder);
        Assert.NotNull(vm.BrowseImageCommand);
    }
    
    [Fact]
    public async Task BrowseCommand_UpdatesValue_WithSelectedPath()
    {
        // arrange
        var mockDialog = new Mock<IFileDialogService>();
        mockDialog.Setup(d => d.ShowOpenFileDialog(It.IsAny<OpenFileDialog>()))
            .ReturnsAsync(new[] { "/path/to/image.png" });
        
        var vm = new PlaceholderValueViewModel(mockDialog.Object);
        
        // act
        await vm.BrowseImageCommand.Execute();
        
        // assert
        Assert.Equal("/path/to/image.png", vm.Value);
    }
}
```

### 6. End-to-End Integration Tests
**File:** `tests/DocxTemplate.Integration.Tests/ImagePlaceholderE2ETests.cs`

```csharp
public class ImagePlaceholderE2ETests
{
    [Fact]
    public async Task CompleteImageReplacementWorkflow_Works()
    {
        // arrange - prepare test document with image placeholders
        var templatePath = PrepareTestTemplate();
        var outputPath = GetTestOutputPath();
        var imagePath = GetTestImagePath();
        
        // act - run complete workflow
        var discoveryService = new TemplateDiscoveryService();
        var scanService = new PlaceholderScanService();
        var replaceService = new PlaceholderReplaceService();
        
        var templates = await discoveryService.DiscoverAsync(templatePath);
        var scanResult = await scanService.ScanAsync(templates.First());
        
        var replacements = new Dictionary<string, string>
        {
            { "logo", imagePath },
            { "companyName", "Test Company" }
        };
        
        await replaceService.ReplaceAsync(
            templates.First().Path, 
            outputPath, 
            replacements);
        
        // assert - verify output document
        Assert.True(File.Exists(outputPath));
        using var doc = WordprocessingDocument.Open(outputPath, false);
        
        var images = doc.MainDocumentPart.Document
            .Descendants<Drawing>().Count();
        Assert.Equal(1, images);
        
        var texts = doc.MainDocumentPart.Document
            .Descendants<Text>()
            .Where(t => t.Text.Contains("Test Company"));
        Assert.NotEmpty(texts);
    }
}
```

## Test Data Preparation
Create test resources folder:
```
tests/TestResources/
├── Images/
│   ├── test-logo.png (200x100)
│   ├── test-photo.jpg (800x600)
│   └── test-icon.gif (32x32)
├── Templates/
│   ├── template-with-image.docx
│   └── template-mixed-placeholders.docx
└── Expected/
    └── expected-output.docx
```

## Performance Tests
```csharp
[Fact]
public async Task ImageReplacement_PerformanceTest()
{
    // Test < 2 seconds for typical image
    var stopwatch = Stopwatch.StartNew();
    await ReplaceImageAsync(/*...*/);
    stopwatch.Stop();
    
    Assert.True(stopwatch.ElapsedMilliseconds < 2000);
}
```

## Cross-Platform Tests
- Run on Windows CI
- Run on macOS CI  
- Run on Linux CI (if applicable)

## Success Criteria
- [ ] All unit tests pass (minimum 90% coverage)
- [ ] Integration tests pass
- [ ] E2E test demonstrates complete workflow
- [ ] Performance within requirements (<2s)
- [ ] Cross-platform compatibility verified
- [ ] No regression in existing tests

## Estimated Time: 2.5 hours